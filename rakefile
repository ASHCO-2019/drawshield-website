task :build do
  Rake::Task[:jekyll].invoke
end

task :update do
  Rake::Task[:latest].invoke
  Rake::Task[:gallery].invoke
  Rake::Task[:bump].invoke
end

task :deploy do
  sh %{ rsync -rcv --exclude-from=.deployignore /var/www/test/ /var/www/html }
end

task :deploygallery do
  sh %{ rsync -rcv /var/www/test/gallery/ /var/www/html/gallery }

  sh %{ /home/ubuntu/gems/bin/t update "$(cat tools/tweet.txt)" } 
end

task :deploycatalog do
  sh %{ rsync -rcv /var/www/test/catalog/ /var/www/html/catalog }
  FileUtils.cp( "/var/www/test/api-bin/catalog.txt", "/var/www/html/api-bin/catalog.txt")
end

desc 'Jekyll Build'
task :jekyll do
  sh %{ bundle exec jekyll build -d /var/www/test }
end

desc 'Commit and Push to git'
task :dogit do
  sh %{ git add -A }
  sh %{ git commit -m "Gallery Updates" }
  sh %{ git push }
end

desc 'Gallery & catalog Build'
task :gallery do
  Dir.chdir('tools') do
    sh %{ php mkgallery.php }
    sh %{ php mkcatalog.php }
  end
end

desc 'Catalog Images'
task :catalog do
  Dir.chdir('tools') do
    sh %{ php compile.php }
  end
end

desc 'submit Gallery Entries'
task :submit do
#    sh %{ git pull }
  Dir.chdir('tools') do
    sh %{ php publish.php }
  end  
end

desc 'Set lowest gallery entry'
task :latest do
  Dir.chdir('tools') do
    sh %{ php latest.php }
  end  
end

desc 'Run test comparisons'
task :runtests do
  Dir.chdir('tests') do
    sh %{ ./runtests.sh }
  end
end

desc 'Bump build number'
task :bump do
  content = File.read('_config.yml')

  version_pattern = /buildNum: ([0-9]+)/
  current_version = content.match(version_pattern)[1]
  next_version    = current_version.to_i + 1

  File.write('_config.yml', content.gsub(version_pattern, "buildNum: #{next_version}"))

  puts "Build number from #{current_version} to #{next_version}!"
end
