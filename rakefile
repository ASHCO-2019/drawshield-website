task :default do
  Rake::Task[:latest].invoke
  Rake::Task[:gallery].invoke
  Rake::Task[:jekyll].invoke
  Rake::Task[:bump].invoke
end

desc 'Jekyll Build'
task :jekyll do
  sh %{ bundle exec jekyll build }
  sh %{ ln -s /mnt/e/Documents/Nextcloud/draw-code/include /var/www/html }
  sh %{ cp /var/www/etc/_htaccess /var/www/html/.htaccess }
  sh %{ chgrp -R www-data /var/www/html }
  #sh %{ chmod -R g+rw /var/www/html }
end

desc 'Bump build number'
task :bump do
  content = File.read('_config.yml')

  version_pattern = /buildNum: ([0-9]+)/
  current_version = content.match(version_pattern)[1]
  next_version    = current_version.to_i + 1

  File.write('_config.yml', content.gsub(version_pattern, "buildNum: #{next_version}"))

  puts "Successfully bumped build number from #{current_version} to #{next_version}!"
end

desc 'Gallery & catalog Build'
task :gallery do
  Dir.chdir('tools') do
    sh %{ php mkgallery.php }
    sh %{ php mkcatalog.php }
  end
end

desc 'Catalog Images'
task :catalog do
  Dir.chdir('tools') do
    sh %{ php compile.php }
  end
end

desc 'Publish Gallery Entries'
task :publish do
  Dir.chdir('tools') do
    sh %{ php publish.php }
  end  
end

desc 'Set lowest gallery entry'
task :latest do
  Dir.chdir('tools') do
    sh %{ php latest.php }
  end  
end